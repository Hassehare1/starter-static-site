<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Min fÃ¶rsta sida</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <!-- Toppmeny -->
  <nav>
    <a href="/index.html">Hem</a>
    <a href="/about.html">Om</a>
  </nav>

  <main>
    <h1>ðŸš€ Min fÃ¶rsta uppdaterade sida via GitHub och Vercel!</h1>
    <p>Den hÃ¤r sidan Ã¤r deployad automatiskt via GitHub.</p>

    <!-- CITAT -->
    <section>
      <h2>Citat</h2>
      <button id="ping">Klicka mig</button>
      <pre id="out">...</pre>
    </section>

    <hr>

    <!-- AKTIER -->
    <section>
      <h2>Liten aktieâ€“ruta</h2>
      <label for="ticker">Ticker (Stooq-format, t.ex. NVDA.US, AAPL.US, MSFT.US, TSLA.US, BMW.DE):</label>
      <input id="ticker" value="NVDA.US" style="width:160px" />
      <button id="loadStock">HÃ¤mta kurs</button>

      <div id="stockBox" style="margin-top:1rem;">
        <div id="stockInfo">â€“</div>
        <svg id="chart" width="500" height="220" style="background:#f7f7f7;border:1px solid #ddd"></svg>
        <div id="stockChange" style="margin-top:0.3rem;font-weight:bold;"></div>
      </div>
      <small>ðŸ’¡ Exempel: NVDA.US, AAPL.US, TSLA.US, RHM.DE, NVO.CO, ADUR.US  
      DatakÃ¤lla: Stooq (dagliga, fÃ¶rdrÃ¶jda kurser).</small>
    </section>
  </main>

  <script>
    // ---------- CITAT ----------
    async function getQuote() {
      const out = document.getElementById("out");
      out.textContent = "HÃ¤mtar...";
      try {
        const r = await fetch("/api/quote?ts=" + Date.now(), { cache: "no-store" });
        if (!r.ok) throw new Error("API-fel " + r.status);
        const d = await r.json();
        out.textContent = `â€œ${d.content}â€ â€” ${d.author}`;
      } catch (e) {
        out.textContent = "Kunde inte hÃ¤mta data.";
        console.error(e);
      }
    }
    document.getElementById("ping").addEventListener("click", getQuote);
    getQuote();

    // ---------- AKTIER ----------
    document.getElementById("loadStock").addEventListener("click", loadStock);
    loadStock(); // hÃ¤mta fÃ¶rsta direkt

    async function loadStock() {
      const t = document.getElementById("ticker").value.trim() || "NVDA.US";
      const info = document.getElementById("stockInfo");
      const svg = document.getElementById("chart");
      const changeBox = document.getElementById("stockChange");
      info.textContent = "HÃ¤mtar...";
      changeBox.textContent = "";
      while (svg.firstChild) svg.removeChild(svg.firstChild);

      try {
        const r = await fetch("/api/stock?ticker=" + encodeURIComponent(t) + "&ts=" + Date.now(), { cache: "no-store" });
        if (!r.ok) throw new Error("API " + r.status);
        const d = await r.json();
        if (d.error) throw new Error(d.detail || d.error);

        info.textContent = `${d.ticker}: ${d.lastClose.toFixed(2)} (senast ${d.lastDate})`;

        // berÃ¤kna fÃ¶rÃ¤ndring i procent
        const first = d.series[0].close;
        const last = d.lastClose;
        const changePct = ((last - first) / first) * 100;
        const sign = changePct >= 0 ? "+" : "";
        changeBox.textContent = `${sign}${changePct.toFixed(1)} % senaste ${d.series.length} dagar`;
        changeBox.style.color = changePct >= 0 ? "green" : "red";

        // RITA GRAF
        const W = 500, H = 220, P = 15;
        const data = d.series;
        const xs = data.map((_, i) => P + i * ((W - 2 * P) / Math.max(1, data.length - 1)));
        const vals = data.map(pt => pt.close);
        const min = Math.min(...vals), max = Math.max(...vals);
        const scaleY = v => H - P - ((v - min) / (max - min || 1)) * (H - 2 * P);

        // axel
        const ax = document.createElementNS("http://www.w3.org/2000/svg", "line");
        ax.setAttribute("x1", P); ax.setAttribute("y1", H - P);
        ax.setAttribute("x2", W - P); ax.setAttribute("y2", H - P);
        ax.setAttribute("stroke", "#ccc");
        svg.appendChild(ax);

        // linje
        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        let dAttr = "";
        data.forEach((pt, i) => {
          const x = xs[i];
          const y = scaleY(pt.close);
          dAttr += (i ? " L " : "M ") + x + " " + y;
        });
        path.setAttribute("d", dAttr);
        path.setAttribute("fill", "none");
        path.setAttribute("stroke", "#0077ff");
        path.setAttribute("stroke-width", "2.2");
        svg.appendChild(path);

        // max/min etiketter
        const mkText = (txt, x, y) => {
          const el = document.createElementNS("http://www.w3.org/2000/svg", "text");
          el.textContent = txt;
          el.setAttribute("x", x);
          el.setAttribute("y", y);
          el.setAttribute("font-size", "11");
          el.setAttribute("fill", "#333");
          svg.appendChild(el);
        };
        mkText(max.toFixed(2), W - 65, scaleY(max) - 4);
        mkText(min.toFixed(2), W - 65, scaleY(min) + 14);

      } catch (e) {
        info.textContent = "Kunde inte hÃ¤mta kurs.";
        console.error(e);
      }
    }
  </script>
</body>
</html>
