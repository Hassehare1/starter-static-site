<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Min f√∂rsta sida</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <!-- Toppmeny -->
  <nav>
    <a href="/index.html">Hem</a>
    <a href="/about.html">Om</a>
  </nav>

  <main>
    <h1>üöÄ Min f√∂rsta uppdaterade sida via GitHub och Vercel!</h1>
    <p>Den h√§r sidan √§r deployad automatiskt via GitHub.</p>

    <!-- CITAT -->
    <section>
      <h2>Citat</h2>
      <button id="ping">Klicka mig</button>
      <pre id="out">...</pre>
    </section>

    <hr>

    <!-- AKTIER -->
    <section>
      <h2>Liten aktie‚Äìruta</h2>
      <label for="ticker">Ticker (Stooq-format, t.ex. NVDA.US, AAPL.US, MSFT.US, TSLA.US, BMW.DE):</label>
      <input id="ticker" value="NVDA.US" style="width:160px" />
      <button id="loadStock">H√§mta kurs</button>

      <div id="stockBox" style="margin-top:1rem;">
        <div id="stockInfo">‚Äì</div>
        <svg id="chart" width="500" height="220" style="background:#f7f7f7;border:1px solid #ddd"></svg>
        <div id="stockChange" style="margin-top:0.3rem;font-weight:bold;"></div>
      </div>
      <small>üí° Exempel: NVDA.US, AAPL.US, TSLA.US, RHM.DE, NVO.CO, ADUR.US  
      Datak√§lla: Stooq (dagliga, f√∂rdr√∂jda kurser).</small>
    </section>
  </main>

  <script>
    // ---------- CITAT ----------
    async function getQuote() {
      const out = document.getElementById("out");
      out.textContent = "H√§mtar...";
      try {
        const r = await fetch("/api/quote?ts=" + Date.now(), { cache: "no-store" });
        if (!r.ok) throw new Error("API-fel " + r.status);
        const d = await r.json();
        out.textContent = `‚Äú${d.content}‚Äù ‚Äî ${d.author}`;
      } catch (e) {
        out.textContent = "Kunde inte h√§mta data.";
        console.error(e);
      }
    }
    document.getElementById("ping").addEventListener("click", getQuote);
    getQuote();

    // ---------- AKTIER ----------
    document.getElementById("loadStock").addEventListener("click", loadStock);
    loadStock(); // h√§mta f√∂rsta direkt

    // Hj√§lpare: ber√§kna SMA √∂ver array av tal
    function calcSMA(values, window) {
      const out = [];
      if (values.length < 1) return out;
      let sum = 0;
      for (let i = 0; i < values.length; i++) {
        sum += values[i];
        if (i >= window) sum -= values[i - window];
        if (i >= window - 1) {
          out.push({ i, v: sum / window }); // i = index i ursprungsserien
        }
      }
      return out; // [{i, v}, ...] b√∂rjar vid window-1
    }

    // Hj√§lpare: skapa SVG-path av punkter
    function pathFromPoints(points) {
      return points.map((p, i) => (i ? "L" : "M") + p.x + " " + p.y).join(" ");
    }

    async function loadStock() {
      const t = document.getElementById("ticker").value.trim() || "NVDA.US";
      const info = document.getElementById("stockInfo");
      const svg = document.getElementById("chart");
      const changeBox = document.getElementById("stockChange");
      info.textContent = "H√§mtar...";
      changeBox.textContent = "";
      while (svg.firstChild) svg.removeChild(svg.firstChild);

      try {
        const r = await fetch("/api/stock?ticker=" + encodeURIComponent(t) + "&ts=" + Date.now(), { cache: "no-store" });
        if (!r.ok) throw new Error("API " + r.status);
        const d = await r.json();
        if (d.error) throw new Error(d.detail || d.error);

        info.textContent = `${d.ticker}: ${d.lastClose.toFixed(2)} (senast ${d.lastDate})`;

        // f√∂r√§ndring i procent f√∂r hela visade f√∂nstret
        const first = d.series[0].close;
        const last = d.lastClose;
        const changePct = ((last - first) / first) * 100;
        const sign = changePct >= 0 ? "+" : "";
        changeBox.textContent = `${sign}${changePct.toFixed(1)} % senaste ${d.series.length} dagar`;
        changeBox.style.color = changePct >= 0 ? "green" : "red";

        // --- RITA GRAF ---
        const W = 500, H = 220, P = 15;
        const data = d.series;          // [{date, close}, ...] √§ldre ‚Üí nyare
        const vals = data.map(pt => pt.close);
        const xs = data.map((_, i) => P + i * ((W - 2 * P) / Math.max(1, data.length - 1)));
        const min = Math.min(...vals), max = Math.max(...vals);
        const scaleY = v => H - P - ((v - min) / (max - min || 1)) * (H - 2 * P);

        // axel
        const ax = document.createElementNS("http://www.w3.org/2000/svg", "line");
        ax.setAttribute("x1", P); ax.setAttribute("y1", H - P);
        ax.setAttribute("x2", W - P); ax.setAttribute("y2", H - P);
        ax.setAttribute("stroke", "#ccc");
        svg.appendChild(ax);

        // prislinje
        const pricePts = data.map((pt, i) => ({ x: xs[i], y: scaleY(pt.close) }));
        const pricePath = document.createElementNS("http://www.w3.org/2000/svg", "path");
        pricePath.setAttribute("d", pathFromPoints(pricePts));
        pricePath.setAttribute("fill", "none");
        pricePath.setAttribute("stroke", "#0077ff");
        pricePath.setAttribute("stroke-width", "2.2");
        svg.appendChild(pricePath);

        // SMA 20 och 50
        const sma20 = calcSMA(vals, 20);
        const sma50 = calcSMA(vals, 50);

        if (sma20.length) {
          const pts20 = sma20.map(p => ({ x: xs[p.i], y: scaleY(p.v) }));
          const path20 = document.createElementNS("http://www.w3.org/2000/svg", "path");
          path20.setAttribute("d", pathFromPoints(pts20));
          path20.setAttribute("fill", "none");
          path20.setAttribute("stroke", "#ff8c00"); // orange
          path20.setAttribute("stroke-width", "1.6");
          svg.appendChild(path20);
        }

        if (sma50.length) {
          const pts50 = sma50.map(p => ({ x: xs[p.i], y: scaleY(p.v) }));
          const path50 = document.createElementNS("http://www.w3.org/2000/svg", "path");
          path50.setAttribute("d", pathFromPoints(pts50));
          path50.setAttribute("fill", "none");
          path50.setAttribute("stroke", "#6a5acd"); // slateblue
          path50.setAttribute("stroke-width", "1.6");
          svg.appendChild(path50);
        }

        // min/max-etiketter
        const mkText = (txt, x, y, color="#333") => {
          const el = document.createElementNS("http://www.w3.org/2000/svg", "text");
          el.textContent = txt;
          el.setAttribute("x", x);
          el.setAttribute("y", y);
          el.setAttribute("font-size", "11");
          el.setAttribute("fill", color);
          svg.appendChild(el);
        };
        mkText(max.toFixed(2), W - 65, scaleY(max) - 4);
        mkText(min.toFixed(2), W - 65, scaleY(min) + 14);

        // legend
        function legendLine(x, y, color, label) {
          const l = document.createElementNS("http://www.w3.org/2000/svg", "line");
          l.setAttribute("x1", x); l.setAttribute("y1", y);
          l.setAttribute("x2", x+20); l.setAttribute("y2", y);
          l.setAttribute("stroke", color);
          l.setAttribute("stroke-width", "2");
          svg.appendChild(l);
          mkText(label, x+26, y+4, "#333");
        }
        legendLine(P, P + 4, "#0077ff", "Pris");
        legendLine(P + 80, P + 4, "#ff8c00", "SMA20");
        legendLine(P + 170, P + 4, "#6a5acd", "SMA50");

      } catch (e) {
        info.textContent = "Kunde inte h√§mta kurs.";
        console.error(e);
      }
    }
  </script>
</body>
</html>
