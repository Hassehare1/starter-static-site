<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Min fÃ¶rsta sida</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <!-- Toppmeny -->
  <nav>
    <a href="/index.html">Hem</a>
    <a href="/about.html">Om</a>
  </nav>

  <main>
    <h1>ðŸš€ Min fÃ¶rsta uppdaterade sida via GitHub och Vercel!</h1>
    <p>Den hÃ¤r sidan Ã¤r deployad automatiskt via GitHub.</p>

    <!-- CITAT -->
    <section>
      <h2>Citat</h2>
      <button id="ping">Klicka mig</button>
      <pre id="out">...</pre>
    </section>

    <hr>

    <!-- AKTIER -->
    <section>
      <h2>Liten aktieâ€“ruta</h2>
      <label for="ticker">VÃ¤lj eller skriv en ticker:</label>
      <select id="ticker">
        <option value="NVDA.US">NVIDIA (NVDA.US)</option>
        <option value="AAPL.US">Apple (AAPL.US)</option>
        <option value="MSFT.US">Microsoft (MSFT.US)</option>
        <option value="TSLA.US">Tesla (TSLA.US)</option>
        <option value="RHM.DE">Rheinmetall (RHM.DE)</option>
        <option value="NVO.CO">Novo Nordisk (NVO.CO)</option>
        <option value="ADURO.CA">Aduro Clean Tech (ADURO.CA)</option>
        <option value="BMW.DE">BMW (BMW.DE)</option>
      </select>
      <button id="loadStock">HÃ¤mta kurs</button>

      <div id="stockBox" style="margin-top:1rem;">
        <div id="stockInfo">â€“</div>
        <svg id="chart" width="360" height="140" style="background:#f7f7f7;border:1px solid #ddd"></svg>
      </div>
      <small>ðŸ’¡ Exempel: NVDA.US, AAPL.US, TSLA.US, RHM.DE, NVO.CO  
      (kÃ¤lla: Stooq â€“ dagliga, fÃ¶rdrÃ¶jda kurser)</small>
    </section>
  </main>

  <script>
    // ---------- CITAT ----------
    async function getQuote() {
      const out = document.getElementById("out");
      out.textContent = "HÃ¤mtar...";
      try {
        const r = await fetch("/api/quote?ts=" + Date.now(), { cache: "no-store" });
        if (!r.ok) throw new Error("API-fel " + r.status);
        const d = await r.json();
        out.textContent = `â€œ${d.content}â€ â€” ${d.author}`;
      } catch (e) {
        out.textContent = "Kunde inte hÃ¤mta data.";
        console.error(e);
      }
    }
    document.getElementById("ping").addEventListener("click", getQuote);
    getQuote();

    // ---------- AKTIER ----------
    document.getElementById("loadStock").addEventListener("click", loadStock);
    loadStock(); // hÃ¤mta fÃ¶rsta direkt

    async function loadStock() {
      const t = document.getElementById("ticker").value.trim() || "NVDA.US";
      const info = document.getElementById("stockInfo");
      const svg = document.getElementById("chart");
      info.textContent = "HÃ¤mtar...";
      while (svg.firstChild) svg.removeChild(svg.firstChild);

      try {
        const r = await fetch("/api/stock?ticker=" + encodeURIComponent(t) + "&ts=" + Date.now(), { cache: "no-store" });
        if (!r.ok) throw new Error("API " + r.status);
        const d = await r.json();
        if (d.error) throw new Error(d.detail || d.error);

        info.textContent = `${d.ticker}: ${d.lastClose.toFixed(2)} (senast ${d.lastDate})`;

        // RITA GRAF
        const W = 360, H = 140, P = 10;
        const data = d.series;
        const xs = data.map((_, i) => P + i * ((W - 2 * P) / Math.max(1, data.length - 1)));
        const vals = data.map(pt => pt.close);
        const min = Math.min(...vals), max = Math.max(...vals);
        const scaleY = v => H - P - ((v - min) / (max - min || 1)) * (H - 2 * P);

        const ax = document.createElementNS("http://www.w3.org/2000/svg", "line");
        ax.setAttribute("x1", P); ax.setAttribute("y1", H - P);
        ax.setAttribute("x2", W - P); ax.setAttribute("y2", H - P);
        ax.setAttribute("stroke", "#ccc");
        svg.appendChild(ax);

        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        let dAttr = "";
        data.forEach((pt, i) => {
          const x = xs[i];
          const y = scaleY(pt.close);
          dAttr += (i ? " L " : "M ") + x + " " + y;
        });
        path.setAttribute("d", dAttr);
        path.setAttribute("fill", "none");
        path.setAttribute("stroke", "#0077ff");
        path.setAttribute("stroke-width", "2");
        svg.appendChild(path);

        const mkText = (txt, x, y) => {
          const el = document.createElementNS("http://www.w3.org/2000/svg", "text");
          el.textContent = txt;
          el.setAttribute("x", x);
          el.setAttribute("y", y);
          el.setAttribute("font-size", "10");
          el.setAttribute("fill", "#444");
          svg.appendChild(el);
        };
        mkText(max.toFixed(2), W - 60, scaleY(max) - 4);
        mkText(min.toFixed(2), W - 60, scaleY(min) + 12);

      } catch (e) {
        info.textContent = "Kunde inte hÃ¤mta kurs.";
        console.error(e);
      }
    }
  </script>
</body>
</html>
